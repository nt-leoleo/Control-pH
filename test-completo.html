<!DOCTYPE html>
<html>
<head>
    <title>Test Completo ESP32</title>
    <style>
        body { font-family: Arial; margin: 20px; background: #1a1a1a; color: white; }
        .container { max-width: 1000px; margin: 0 auto; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #333; border-radius: 8px; }
        .success { background: #1a4a1a; border-color: #22c55e; }
        .error { background: #4a1a1a; border-color: #ef4444; }
        .info { background: #1a1a4a; border-color: #3b82f6; }
        .warning { background: #4a4a1a; border-color: #eab308; }
        .debug { background: #2a1a4a; border-color: #a855f7; }
        
        .controls { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; margin: 20px 0; }
        button { padding: 10px 15px; background: #3b82f6; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 14px; }
        button:hover { background: #2563eb; }
        button.success { background: #22c55e; }
        button.error { background: #ef4444; }
        button.warning { background: #eab308; }
        
        pre { background: #0a0a0a; padding: 10px; border-radius: 4px; overflow-x: auto; font-size: 12px; border: 1px solid #333; }
        input { padding: 8px; margin: 5px; border: 1px solid #333; border-radius: 4px; background: #2a2a2a; color: white; width: 300px; }
        
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin: 20px 0; }
        .stat { text-align: center; padding: 10px; background: #2a2a2a; border-radius: 5px; }
        .stat-value { font-size: 24px; font-weight: bold; }
        .stat-label { font-size: 12px; opacity: 0.7; }
        
        #results { max-height: 600px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ Test Completo ESP32 - Diagn√≥stico Total</h1>
        
        <div class="stats">
            <div class="stat">
                <div class="stat-value" id="testsPassed">0</div>
                <div class="stat-label">Tests Exitosos</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="testsFailed">0</div>
                <div class="stat-label">Tests Fallidos</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="avgResponseTime">0ms</div>
                <div class="stat-label">Tiempo Promedio</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="connectionStatus">‚ùå</div>
                <div class="stat-label">Estado ESP32</div>
            </div>
        </div>

        <div class="test-section info">
            <h3>üéØ Configuraci√≥n de Test - Sistema Remoto</h3>
            <div>
                <label>Canal ThingSpeak:</label>
                <input type="text" id="channelID" value="3249157" readonly>
                <label>API URL:</label>
                <input type="text" id="apiURL" value="https://api.thingspeak.com/channels/3249157/feeds/last.json" readonly>
            </div>
        </div>

        <div class="controls">
            <button onclick="testThingSpeakAPI()">üåê Test ThingSpeak API</button>
            <button onclick="testConnectionStatus()">üì° Test Conexi√≥n</button>
            <button onclick="testPHData()">üß™ Test Datos pH</button>
            <button onclick="testHistoryData()">üìà Test Historial</button>
            <button onclick="testSystemInfo()">‚ÑπÔ∏è Info Sistema</button>
            <button onclick="testDosingCommand()">üíä Test Dosificaci√≥n</button>
            <button onclick="testWebApp()">üì± Test App Web</button>
            <button onclick="testAll()">üöÄ Test Completo</button>
            <button onclick="clearResults()">üßπ Limpiar</button>
        </div>

        <div class="test-section warning">
            <h3>üìã Instrucciones - Sistema Remoto:</h3>
            <ol>
                <li><strong>Test ThingSpeak API:</strong> Verifica conectividad con ThingSpeak</li>
                <li><strong>Test Conexi√≥n:</strong> Verifica estado del ESP32 remoto</li>
                <li><strong>Test Datos pH:</strong> Obtiene datos actuales de pH</li>
                <li><strong>Test Historial:</strong> Obtiene historial de datos</li>
                <li><strong>Info Sistema:</strong> Informaci√≥n completa del sistema</li>
                <li><strong>Test Dosificaci√≥n:</strong> Prueba comandos de dosificaci√≥n</li>
                <li><strong>Test App Web:</strong> Verifica integraci√≥n con app React</li>
                <li><strong>Test Completo:</strong> Ejecuta todos los tests autom√°ticamente</li>
            </ol>
            <div style="background: #e9ecef; padding: 10px; margin-top: 10px; border-radius: 5px; color: #333;">
                <strong>üåê Sistema Remoto:</strong> Ahora el sistema funciona completamente remoto usando ThingSpeak. 
                El ESP32 env√≠a datos a la nube y la app web los lee desde all√≠. No hay problemas de CORS ni IP local.
            </div>
        </div>

        <div id="results"></div>
    </div>

    <script>
        const results = document.getElementById('results');
        let testStats = { passed: 0, failed: 0, responseTimes: [] };
        
        // Configuraci√≥n del sistema remoto
        const THINGSPEAK_CONFIG = {
            CHANNEL_ID: '3249157',
            API_URL: 'https://api.thingspeak.com/channels/3249157/feeds/last.json',
            HISTORY_URL: 'https://api.thingspeak.com/channels/3249157/feeds.json'
        };

        function updateStats() {
            document.getElementById('testsPassed').textContent = testStats.passed;
            document.getElementById('testsFailed').textContent = testStats.failed;
            
            const avgTime = testStats.responseTimes.length > 0 
                ? Math.round(testStats.responseTimes.reduce((a, b) => a + b, 0) / testStats.responseTimes.length)
                : 0;
            document.getElementById('avgResponseTime').textContent = avgTime + 'ms';
            
            const isConnected = testStats.passed > 0 && testStats.passed > testStats.failed;
            document.getElementById('connectionStatus').textContent = isConnected ? '‚úÖ' : '‚ùå';
        }

        function addResult(message, type = 'info', responseTime = null) {
            const div = document.createElement('div');
            div.className = `test-section ${type}`;
            div.innerHTML = `<strong>${new Date().toLocaleTimeString()}</strong>${responseTime ? ` (${responseTime}ms)` : ''}<br>${message}`;
            results.appendChild(div);
            results.scrollTop = results.scrollHeight;
            
            if (type === 'success') {
                testStats.passed++;
                if (responseTime) testStats.responseTimes.push(responseTime);
            } else if (type === 'error') {
                testStats.failed++;
            }
            updateStats();
        }

        function clearResults() {
            results.innerHTML = '';
            testStats = { passed: 0, failed: 0, responseTimes: [] };
            updateStats();
        }

        async function testThingSpeakAPI() {
            addResult('üåê Probando conectividad con ThingSpeak API...', 'info');
            const startTime = Date.now();
            
            try {
                const response = await fetch(THINGSPEAK_CONFIG.API_URL, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                const responseTime = Date.now() - startTime;
                
                if (response.ok) {
                    const data = await response.json();
                    addResult(`‚úÖ ThingSpeak API funciona perfectamente!<br>Status: ${response.status}<br>Canal: ${data.channel_id}<br>√öltima entrada: ${data.entry_id}`, 'success', responseTime);
                } else {
                    addResult(`‚ùå Error ThingSpeak API: ${response.status} ${response.statusText}`, 'error', responseTime);
                }
                
            } catch (error) {
                const responseTime = Date.now() - startTime;
                addResult(`‚ùå Error conectando con ThingSpeak: ${error.message}`, 'error', responseTime);
            }
        }

        async function testConnectionStatus() {
            addResult('üì° Verificando estado de conexi√≥n del ESP32...', 'info');
            const startTime = Date.now();
            
            try {
                const response = await fetch(THINGSPEAK_CONFIG.API_URL);
                const responseTime = Date.now() - startTime;
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Verificar si los datos son recientes (menos de 5 minutos)
                    const dataTimestamp = new Date(data.created_at).getTime();
                    const now = Date.now();
                    const dataAge = now - dataTimestamp;
                    const isRecent = dataAge < 300000; // 5 minutos
                    
                    const ageMinutes = Math.round(dataAge / 60000);
                    
                    if (isRecent) {
                        addResult(`‚úÖ ESP32 CONECTADO y funcionando!<br>√öltima actualizaci√≥n: hace ${ageMinutes} minutos<br>Entry ID: ${data.entry_id}`, 'success', responseTime);
                    } else {
                        addResult(`‚ö†Ô∏è ESP32 posiblemente desconectado<br>√öltima actualizaci√≥n: hace ${ageMinutes} minutos<br>Datos obsoletos`, 'warning', responseTime);
                    }
                } else {
                    addResult(`‚ùå Error verificando conexi√≥n: ${response.status}`, 'error', responseTime);
                }
                
            } catch (error) {
                const responseTime = Date.now() - startTime;
                addResult(`‚ùå Error verificando conexi√≥n: ${error.message}`, 'error', responseTime);
            }
        }

        async function testPHData() {
            addResult('üß™ Obteniendo datos de pH del ESP32...', 'info');
            const startTime = Date.now();
            
            try {
                const response = await fetch(THINGSPEAK_CONFIG.API_URL);
                const responseTime = Date.now() - startTime;
                
                if (response.ok) {
                    const data = await response.json();
                    
                    const ph = parseFloat(data.field1);
                    const voltage = parseFloat(data.field2);
                    const wifiRSSI = parseInt(data.field3);
                    const uptime = parseInt(data.field4);
                    
                    let phStatus = 'Neutro';
                    if (ph < 6.5) phStatus = '√Åcido (necesita pH+)';
                    else if (ph > 7.5) phStatus = 'B√°sico (necesita pH-)';
                    
                    addResult(`‚úÖ Datos de pH obtenidos exitosamente!<br>
                        <strong>pH:</strong> ${ph.toFixed(2)} (${phStatus})<br>
                        <strong>Voltaje:</strong> ${voltage.toFixed(3)}V<br>
                        <strong>WiFi:</strong> ${wifiRSSI} dBm<br>
                        <strong>Uptime:</strong> ${uptime}s<br>
                        <strong>Timestamp:</strong> ${new Date(data.created_at).toLocaleString()}`, 'success', responseTime);
                } else {
                    addResult(`‚ùå Error obteniendo datos pH: ${response.status}`, 'error', responseTime);
                }
                
            } catch (error) {
                const responseTime = Date.now() - startTime;
                addResult(`‚ùå Error obteniendo datos pH: ${error.message}`, 'error', responseTime);
            }
        }

        async function testHistoryData() {
            addResult('üìà Obteniendo historial de datos...', 'info');
            const startTime = Date.now();
            
            try {
                const response = await fetch(`${THINGSPEAK_CONFIG.HISTORY_URL}?results=10`);
                const responseTime = Date.now() - startTime;
                
                if (response.ok) {
                    const data = await response.json();
                    const feeds = data.feeds.filter(feed => feed.field1);
                    
                    addResult(`‚úÖ Historial obtenido exitosamente!<br>
                        <strong>Entradas:</strong> ${feeds.length}<br>
                        <strong>Canal:</strong> ${data.channel.name}<br>
                        <strong>Descripci√≥n:</strong> ${data.channel.description}<br>
                        <strong>√öltima entrada:</strong> ${feeds[feeds.length - 1]?.created_at}`, 'success', responseTime);
                        
                    // Mostrar √∫ltimas 3 lecturas
                    const recent = feeds.slice(-3);
                    let historyHTML = '<br><strong>√öltimas 3 lecturas:</strong><br>';
                    recent.forEach(feed => {
                        const ph = parseFloat(feed.field1);
                        const time = new Date(feed.created_at).toLocaleTimeString();
                        historyHTML += `${time}: pH ${ph.toFixed(2)}<br>`;
                    });
                    
                    addResult(historyHTML, 'info');
                } else {
                    addResult(`‚ùå Error obteniendo historial: ${response.status}`, 'error', responseTime);
                }
                
            } catch (error) {
                const responseTime = Date.now() - startTime;
                addResult(`‚ùå Error obteniendo historial: ${error.message}`, 'error', responseTime);
            }
        }

        async function testSystemInfo() {
            addResult('‚ÑπÔ∏è Obteniendo informaci√≥n completa del sistema...', 'info');
            
            try {
                // Importar el m√≥dulo de comunicaci√≥n
                const { getSystemInfo } = await import('./src/esp32Communication.js');
                const systemInfo = await getSystemInfo();
                
                if (systemInfo) {
                    addResult(`‚úÖ Informaci√≥n del sistema obtenida!<br>
                        <strong>Conectado:</strong> ${systemInfo.connected ? 'S√≠' : 'No'}<br>
                        <strong>Fuente:</strong> ${systemInfo.source}<br>
                        <strong>Canal ID:</strong> ${systemInfo.channel_id}<br>
                        <strong>API URL:</strong> ${systemInfo.api_url}<br>
                        <strong>Timeout:</strong> ${systemInfo.config.timeout}ms`, 'success');
                } else {
                    addResult('‚ùå No se pudo obtener informaci√≥n del sistema', 'error');
                }
                
            } catch (error) {
                addResult(`‚ùå Error obteniendo info del sistema: ${error.message}`, 'error');
            }
        }

        async function testDosingCommand() {
            addResult('üíä Probando comando de dosificaci√≥n...', 'info');
            
            try {
                // Importar el m√≥dulo de comunicaci√≥n
                const { sendDosingCommand } = await import('./src/esp32Communication.js');
                
                const dosingConfig = {
                    product: 'acid',
                    duration: 1,
                    intensity: 'low'
                };
                
                const result = await sendDosingCommand(dosingConfig);
                
                if (result.success) {
                    addResult(`‚úÖ Comando de dosificaci√≥n enviado!<br>
                        <strong>Mensaje:</strong> ${result.message}<br>
                        <strong>Timestamp:</strong> ${result.timestamp}<br>
                        <strong>Config:</strong> ${JSON.stringify(result.config)}`, 'success');
                } else {
                    addResult(`‚ùå Error enviando comando: ${result.message}`, 'error');
                }
                
            } catch (error) {
                addResult(`‚ùå Error en comando de dosificaci√≥n: ${error.message}`, 'error');
            }
        }

        async function testWebApp() {
            addResult('üì± Probando integraci√≥n con app web React...', 'info');
            
            try {
                // Importar funciones del m√≥dulo
                const { checkESP32Connection, getPHDataFromESP32 } = await import('./src/esp32Communication.js');
                
                // Test 1: Verificar conexi√≥n
                addResult('üîç Verificando conexi√≥n...', 'info');
                const isConnected = await checkESP32Connection();
                
                if (isConnected) {
                    addResult('‚úÖ Conexi√≥n verificada exitosamente', 'success');
                    
                    // Test 2: Obtener datos
                    addResult('üìä Obteniendo datos de pH...', 'info');
                    const phData = await getPHDataFromESP32();
                    
                    if (phData) {
                        addResult(`‚úÖ Datos obtenidos exitosamente!<br>
                            <strong>pH:</strong> ${phData.ph}<br>
                            <strong>Estado:</strong> ${phData.phStatus.label}<br>
                            <strong>Dispositivo:</strong> ${phData.device_id}<br>
                            <strong>Fuente:</strong> ${phData.source}<br>
                            <strong>Datos recientes:</strong> ${phData.isRecent ? 'S√≠' : 'No'}`, 'success');
                    } else {
                        addResult('‚ùå No se pudieron obtener datos de pH', 'error');
                    }
                } else {
                    addResult('‚ùå Conexi√≥n fallida', 'error');
                }
                
            } catch (error) {
                addResult(`‚ùå Error en integraci√≥n web app: ${error.message}`, 'error');
            }
        }

        async function testAll() {
            addResult('üöÄ Iniciando test completo del sistema remoto...', 'info');
            clearResults();
            
            const tests = [
                { name: 'ThingSpeak API', func: testThingSpeakAPI },
                { name: 'Estado Conexi√≥n', func: testConnectionStatus },
                { name: 'Datos pH', func: testPHData },
                { name: 'Historial', func: testHistoryData },
                { name: 'Info Sistema', func: testSystemInfo },
                { name: 'Dosificaci√≥n', func: testDosingCommand },
                { name: 'App Web', func: testWebApp }
            ];
            
            for (let i = 0; i < tests.length; i++) {
                const test = tests[i];
                addResult(`üìã Ejecutando: ${test.name} (${i + 1}/${tests.length})`, 'info');
                await test.func();
                
                // Pausa entre tests
                if (i < tests.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
            }
            
            addResult('‚úÖ Test completo finalizado', 'success');
            
            // Resumen final
            const total = testStats.passed + testStats.failed;
            const successRate = total > 0 ? Math.round((testStats.passed / total) * 100) : 0;
            addResult(`üìä RESUMEN FINAL: ${testStats.passed}/${total} tests exitosos (${successRate}%)<br>
                ${successRate >= 80 ? 'üéâ Sistema funcionando correctamente!' : 
                  successRate >= 50 ? '‚ö†Ô∏è Sistema parcialmente funcional' : 
                  '‚ùå Sistema con problemas'}`, 
                successRate >= 80 ? 'success' : successRate >= 50 ? 'warning' : 'error');
        }

        // Inicializaci√≥n
        window.onload = () => {
            addResult('üöÄ Test completo ESP32 - Sistema Remoto iniciado', 'info');
            addResult(`üìç Canal ThingSpeak: ${THINGSPEAK_CONFIG.CHANNEL_ID}`, 'info');
            addResult(`üåê API URL: ${THINGSPEAK_CONFIG.API_URL}`, 'info');
            addResult('üí° Usa "Test Completo" para ejecutar todos los tests autom√°ticamente', 'warning');
        };
    </script>
</body>
</html>